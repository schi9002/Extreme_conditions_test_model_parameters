---
title: "Supplementary material - S1: Extreme-condition tests"
author: "Simon Chiu"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())
gc()

library(progress)
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(patchwork)
library(ggh4x)
library(ggpubr)
library(scales)

# devtools::install_github("nicolash2/ggbrace")


load("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity//Data/R/lsa_seq_sample_2023-07-16.RData")
focus_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/focus_df_2023-07-18.RDS")
lsa_bmi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/lsa_bmi_df_2023-07-18.RDS")
det_bmi_df<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/det_bmi_df_2023-07-16.RDS") %>%
rename("bmi.output"="bmi", "age.groups.output"="age.groups", "gender.output"="gender")

sensitivity_ran_variables<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/sensitivity_ran_variables_2023-07-17.RDS")
# 
# list.of.focus.variables<-focus_df %>% 
#   arrange(focus.title, gender.input, bmi.input, age.groups.input) %>% 
#   select(focus.title) %>% 
#   group_by(focus.title) %>% filter(row_number()==1)%>% data.frame()
# 
# list.of.focus.variables.levels<-focus_df %>% 
#   arrange(focus.title, gender.input, bmi.input, age.groups.input) %>% 
#   select(focus) %>% 
#   group_by(focus) %>% filter(row_number()==1)%>% data.frame()
# 
derivative.lsa<-readRDS("/media/simon/ExtSSD/Documents/PhD/4 SD Model/7 Sensitivity/Data/R/derivative_lsa_2023-08-09.RDS")

lsa_bmi_df <- lsa_bmi_df %>% 
left_join(., sensitivity_ran_variables %>% select(label, values),
        by=c("focus"="label")) %>% 
mutate(prop=input.value*100/values)


```

# Introduction
This document presents the results assessing the impact of extreme condition sensitivity analysis for the **D**c**i**sion **S**upport tool for **C**hild and **A**dolescence **O**besity, a system dynamic model developed to explore underlying relationships that contribute to youth obesity.

## Outline of extreme test sensitivity analysis

Extreme conditions test is a stress test where input parameters are varied beyond probabilistic ranges, and model-generated outcome behaviour is examined for consistency with the real or anticipated behaviour of the system (). Models that operate with logical consistency outside of "normal" conditions have greater consistency, building confidence in the model output.

Benefits of extreme conditions test:

1. It can be used to discover flaws in the model's conceptual logic.
2. Aids in identifying non-linear and asymptotic behaviours that can be used to validate the model behaviour and highlight possible impactful policy levers. 
3. enhances the model's usefulness by exploring model behaviour of systems that operate outside of contextual-historical observations, i.e. populations with differing characteristics.

# Methods

A sensitivity analysis was conducted testing 649 input variables between $\pm$ 20% of an input's initial value. While each input value may have more extreme values, these input values are considered to be outside of probable values. For each sensitivity analysis, the model generates 78 BMI prevalence outcomes, 3 BMI categories, 13 age groups and two genders. 

Elementary Effect (EE) was used to summarise the model outcome. These summaries are used to examine model behaviour. Where variables are highlighted as influential, individual input-output relationships plots disaggregate the summary results to examine behaviours further.

## Outcome Measure

The plot below describes how Elementary Effect (EE) are used to summarise sensitivity analysis results.

Panel A shows an example of a model-generated outcome; over modelled time, the input assumptions ($x$) are varied between $\pm$ 20% of it's initial value. The model results at the end of the model are used to calculate the EE (panel B).

The EE is calculated for each model output result to create a sample of EE. The mean and standard deviation are used to summarise the change in outcome per percentage point shift in input assumption. 


$$ EE_{i} = \frac{f(x-\Delta_{i})- f(x)}{\Delta_{i}}$$

$$ \mu_{EE}= \frac{1}{n} \sum_{i=1}^{n} EE_{i}, \hspace{1cm} \sigma_{EE}=\frac{1}{(n-1)} \sum_{i=1}^{n} (EE_{i} - \mu_{EE})^2$$

```{r, echo=F, message=FALSE, warning=F, error=F, fig.height=1*2*5, fig.width=1.6*1*5, fig.cap="Example plot for analysis outcome"}
cc <- scales::seq_gradient_pal("blue", "red", "Lab")(seq(0,1,length.out=6))
x2=0
x3=0.02

data.frame(x=seq(0,50, 0.1)) %>% 
mutate(`Base model`=(0.3/(1+exp(-(1/10)*(x-15))))) %>% 
mutate(int.effect1=ifelse(x>0,`Base model`*(1-((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect2=ifelse(x>0,`Base model`*(1-((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect3=ifelse(x>0,`Base model`*(1-((x2-x3*3))/(1+exp(-1*(0)))), NA)) %>% 
mutate(`Initial assumptions`=ifelse(x>15,`Base model`*(1+((x2))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect5=ifelse(x>0,`Base model`*(1+((x2-x3*3))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect6=ifelse(x>0,`Base model`*(1+((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect7=ifelse(x>0,`Base model`*(1+((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
gather(., type,y,`Base model`:int.effect7) %>% 
mutate(type=factor(case_when(type=="Base model"~1,
                     type=="Initial assumptions"~2,
                    type=="int.effect1"~3,
                    type=="int.effect2"~4,
                    type=="int.effect3"~5,
                    type=="int.effect5"~6,
                    type=="int.effect6"~7,
                    type=="int.effect7"~8),
                  levels=c(1,2,3,4,5,6,7,8),
     labels=c("Base model", "Initial assumptions",
                           paste0("x=",sprintf("%0.1f",-20)),paste0("x=",sprintf("%0.1f",-13)),paste0("x=",sprintf("%0.1f",-6)),
                         paste0("x=",sprintf("%0.1f",6)),paste0("x=",sprintf("%0.1f",13)),paste0("x=",sprintf("%0.1f",20))))) %>%  
mutate(y.point=ifelse(x==50, y, NA)) %>%
ggplot()+
geom_point(aes(x=x, y=y.point,  fill=type), shape=21)+
geom_line(aes(x=x, y=y, color=type, linetype=type), show.legend = F)+
# scale_y_continuous(limits = c(0, 0.35), label=scales::percent)+
scale_fill_manual(values=c("black", "grey", cc))+
scale_color_manual(values=c("black", "black", cc))+
scale_linetype_manual(values=c(1,1, rep(2, 6)))+
theme_bw()+
guides(fill = guide_legend("Model run"),
     linetype = guide_legend("Model run"))+
ylab("Model-generated outcome \n BMI prevalence (%)")+xlab("Modelled time")+
theme(legend.position = "bottom")+
ggtitle("Outcome")+

data.frame(x=seq(0,50, 0.1)) %>% 
mutate(`Base model`=(0.3/(1+exp(-(1/10)*(x-15))))) %>% 
mutate(int.effect1=ifelse(x>0,`Base model`*(1+((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect2=ifelse(x>0,`Base model`*(1+((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect3=ifelse(x>0,`Base model`*(1+((x2-x3*3))/(1+exp(-1*(0)))), NA)) %>% 
mutate(`Initial assumptions`=ifelse(x>15,`Base model`*(1+((x2))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect5=ifelse(x>0,`Base model`*(1+((x2+x3*3))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect6=ifelse(x>0,`Base model`*(1+((x2+x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect7=ifelse(x>0,`Base model`*(1+((x2+x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
gather(., type,y,`Base model`:int.effect7) %>% 
mutate(type.num=case_when(type=="Initial assumptions"~x2,
                    type=="int.effect1"~x2-x3*9,
                    type=="int.effect2"~x2-x3*6,
                    type=="int.effect3"~x2-x3*3,
                    type=="int.effect5"~x2+x3*3,
                    type=="int.effect6"~x2+x3*6,
                    type=="int.effect7"~x2+x3*9)) %>% 
filter(x==50) %>% 
filter(type!="Base model") %>% 
mutate(type.color=c("-20%", "-13%", "-6%", "0%", "6%", "13%", "20%")) %>% 
ggplot()+
# geom_line(aes(x=type.num, y=y), stat = "smooth", alpha=0.1, method="loess")+
geom_line(aes(x=type.num, y=y), alpha=0.1)+
scale_y_continuous(limits = c(0.25, 0.33), label=scales::percent)+
scale_x_continuous(breaks=c(-0.18, -0.12, -0.06, 0.000, 0.06, 0.12, 0.18),
                 labels = c("-20%", "-13%", "-6%", "Initial assumptions", "6%", "13%", "20%"))+
scale_fill_manual(values=c("#0000FF", "#8D00CE", "#BA009F", "grey", "#D70072", "#ED0044", "#FF0000"))+
ggbrace::geom_brace(aes(x=c(0, 0+0.007), y=c(0.2912063-0.001,0.2822063-0.001)),rotate=90, inherit.data=F)+
ggbrace::geom_brace(aes(x=c(-0.06,0), y=c(0.2822063-0.002, 0.2822063-0.002-0.003)),rotate=180, inherit.data=F)+
annotate("text", x = 0.03, y = 0.285, parse = T, label = as.character(expression("f("*x*"+"*Delta*")-f(x)")))+
annotate("text", x = -0.062+(0.06-0)/2, y = 0.275, parse = T, label = as.character(expression(~Delta)))+
annotate("text", x =-0.062+(0.06-0)/2, y = 0.275-0.01, parse = T, label = as.character(expression(paste(EE," = ",frac("f(x+"*Delta*")-f(x)", ~Delta)))))+
geom_point(aes(x=type.num, y=y, fill=type.color), shape=21)+
theme_bw()+
guides(fill = guide_legend("Model run"))+
ylab("Model-generated outcome \n BMI prevalence (%)")+xlab("Percentage of initial input assumptions")+
theme(legend.position = "bottom")+
ggtitle("Outcome at the time 50")+


plot_layout(ncol=1, nrow=2)+
plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")

```



## How to interpret the results
A summary plot (panel A) shows the summary relationships between variation in the input variables (overweight males body weight aged between 6 and 8) and the highlighted outcome, the prevalence of obesity. 

The individual input-output relationships are plotted in the facets of panel B. Each sub-plot shows the model-generated prevalence of obesity at the end of the model for each input assumption.

As the assumed body weight for overweight males aged between 6 and 8 is varied, the plots in panel B show no impact on the prevalence of obesity for 2 and 2 to 5-year-olds, which is also reflected in the zero association in the summary plot. The prevalence of obesity for 6 to 8-year-olds and above have a negative association with 6 to 8-year-old overweight males assumed body weight. The largest associations were in the 9 to 11-year-olds, and the strength of the association tappers out for older age groups.

For every percentage point change in the assumed body weight for overweight males aged 6 to 8 years old, there is, on average, a 0.25% reduction in the prevalence of obesity in 6 to 8-year-olds. This suggests that 25% of the input variability is observed in the outcome.

```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
p.tmp1<-derivative.lsa %>% 
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male' & age.groups.input=="Age 6 8" & bmi.input=="Overweight") %>%
filter(gender.output=='Male') %>%
filter(age.groups.output!="Age 45 49") %>% 
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output), size=1, show.legend = F)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
# scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                  labels=c("3-5", "18-19", "40-44"))+
scale_x_discrete(breaks=c("Age 2","Age 3 5", "Age 6 8", "Age 9 11", "Age 12 14", "Age 15 17",
                        "Age 18 19", "Age 20 24","Age 25 29", "Age 30 34", "Age 35 39", "Age 40 44"),
               labels=c("2", "3-5", "6-8", "9-11","12-14","15-17","18-19", "20-24", "25-29", "30-34", "35-39","40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
scale_alpha_manual(values=c(0.3,0.3,1), )+
ylab(bquote(atop("Average change in BMI %", "per PP change in input assumption (" *mu[EE]*")")))+
guides(colour = guide_legend("BMI outcomes"), alpha = "none")+
ggtitle("Summary plot - Mean Elementary Effect by age",subtitle="Male outcomes")+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               plot.title = element_text(face = c("bold")),
               plot.subtitle = element_text(),
               strip.text = element_text(size = 7),
               axis.title.y = element_text(size=7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))


p.tmp2<-lsa_bmi_df %>% 
rename("Gender input"="gender.input", "BMI outcome"="bmi.output", "BMI input"="bmi.input", 
     "Age input"="age.groups.input", "Gender outcome"="gender.output", "Age output"="age.groups.output") %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>% 
filter(`Gender input`=='Male') %>%
filter(`Gender outcome`=='Male') %>%
filter(`BMI outcome`=="With obesity") %>% 
filter(`BMI input`=="Overweight" ) %>% 
filter(`Age input`=="Age 6 8") %>%
filter(`Age output`!="Age 45 49") %>%
ggplot()+
# geom_point(aes(x=prop-100, y=`2057`), color=hue_pal()(3)[3], size=0.4)+
geom_smooth(aes(x=prop-100, y=`2057`), se=F, linewidth=0.5, color=hue_pal()(3)[3], span=0.25)+
# geom_line(aes(x=input.value, y=diff, color=scenario))+
# geom_line(aes(x=input.value, y=base.model.value), linetype="dashed")+
geom_vline(aes(xintercept=0, color="Initial assumption"), linetype="dashed", alpha=0.3)+
facet_wrap(vars(`Age output`), ncol = 4, nrow=3)+
scale_colour_manual(values = c("black"))+
guides(colour = guide_legend(" "))+
scale_y_continuous(labels = scales::percent, breaks = c(seq(0.05,0.6, 0.15)))+
# scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
#                  limits = c(-20, 20))+
scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
                 limits = c(-20, 20),
                 sec.axis = sec_axis(~(.+100)*30.6/100,
                                     name = "Body weight (Kg) \n",
                                     labels =scales::label_number(suffix = "kg")))+
ylab("Prevalence of obesity")+
xlab(" \n Percentage of initial assumed Body Weight (kg) for overweight males aged 6 to 8")+
ggtitle("Individual relationships", subtitle = "Prevalence of obesity vs assumed Body Weight (kg) for overweight males aged 6 to 8")+
theme_bw() +theme(legend.position = "bottom",
                  panel.spacing.y =unit(0, "mm"),
                  panel.spacing.x =unit(4, "mm"),
                  plot.title = element_text(face = c("bold")),
                  plot.subtitle = element_text())

layout <- '
#AAAAA#
BBBBBBB
BBBBBBB
'
wrap_plots(A = p.tmp1, B = p.tmp2, design = layout, tag_level = "keep")+
plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")
```



# Results
## Overall Ranking of sensitivity

The 649 input assumptions tested can be summarised into 70 variables by taking the mean of age-gender-BMI specific inputs, resulting in 70 overarching variables. These are ranked in the following table.

```{r ,echo=F, message=F, error=F, warning=F}
derivative.lsa %>% 
group_by(focus.title) %>%
summarise(mean=mean(abs.mean.ee.prop.alt)) %>% 
arrange(-mean) %>% 
mutate(focus.title1=case_when(grepl("Commonwealth Healthcare Costs",focus.title)~"Commonwealth Healthcare Costs",
                            grepl("Early Childhood Prevention Cost",focus.title)~"Early Childhood Prevention Cost",
                            grepl("Household Healthcare Costs",focus.title)~"Household Healthcare Costs ",
                            grepl("Productivity Loss of guardians from kids missing school",focus.title)~"Productivity Loss of guardians from kids missing school",
                            grepl("State Healthcare Costs",focus.title)~"State Healthcare Costs",
     grepl("Effect Non-core OR",focus.title)~"Effect Non-core OR")) %>% 
mutate(focus.title=ifelse(is.na(focus.title1), focus.title,focus.title1)) %>% 
select(focus.title, mean) %>% 
rename("Label"="focus.title", "Mean Elementary Effect"="mean") %>%
knitr::kable(.) %>% 
kableExtra::footnote(., "Ranked variables")
```


## Body Weight 
**Change in Male Body Weight input assumptions**

Changes in base model assumptions for body weight alter how changes in energy imbalance impact BMI category prevalence estimates, making the model insensitive to changes based on assumed energy surplus. The figure below shows the elementary effect for each local sensitivity analysis changing the assumed male body weight. 

- Changes in the body weight assumptions reduced the flow of individuals to higher BMI categories, creating higher healthy weight prevalence.
- Younger ages impact the BMI outcomes for all older age groups.
- Older age groups do not impact younger outcomes.
- Changes in each BMI category mainly impact the outcome of the BMI category being changed and the neighbouring BMI category.
- Change in the assumptions for Healthy weight impacts the underweight and healthy weight and overweight outcome.
- Change in the assumptions for overweight mainly impacts the outcome for all BMI categories.
- Changing the obesity assumptions change the obesity and overweight outcomes.

```{r Body Weight Male, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>%   
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Male Body Weight (kg)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```

**Change in Female Body Weight input assumptions**

There are similar relationships, as noted in the male assumptions.

Additionally;

+ The results show the intergenerational effects.
+ Changes in the female assumptions slightly impact the younger age group.
+ The intergenerational effect is stronger when varying assumptions in age groups with higher fertility rates
+ For each PP increase in body weight for Underweight & Healthy weights 20 to 24 resulted in a 
    + 0.57% increase in the Underweight & Healthy 20 to 24 years olds 
    + 0.09% increase in Underweight & Healthy 2-year-old males (15.9% of the adults' effect)
+ For each PP increase in body weight for Underweight & Healthy weight 40 to 44 year-olds resulted in a 
    + 0.39% increase in the Underweight & Healthy 40 to 44-year-olds
    + 0.003% increase in Underweight & Healthy 2-year-old males (0.87% of the adults' effect)
      
This suggests that any prevention intervention for early childhood should be targeted at age groups with higher fertility rates to have a larger impact.


```{r Body Weight Female, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Female Body Weight (kg)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme( legend.position = "bottom")
```

## Height

Similar to changes in the assumed body weight for each cohort, changes in height impact how influential energy surplus and deficits result in changes in the flows between BMI categories. However, height is the least influential in the model compared to body weight.

**Change in Male height input assumptions**
```{r Height Male, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="\"Reference height (m)\"" ) %>% 
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="\"Reference height (m)\"" ) %>% 
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Male height (m)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme( legend.position = "bottom")
```

**Change in Female height input assumptions**
```{r Height Female, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="\"Reference height (m)\"" ) %>% 
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.001))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="\"Reference height (m)\"" ) %>% 
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>%  
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Female height (m)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")
```

## Growth Function kJ/day
Changes in the assumption Kj/day needed for growth resulting in relatively small changes in the BMI outcomes. The largest impact occurred in adolescent age groups where the growth assumptions where the largest. The larger observed impact in males was in 9-11 year olds and 12-15 year olds, where on average 1 Kj resulted in 0.2% change in the outcome. 

```{r Growth Function, echo=F, message=F, error=F, warning=F,  fig.width=1*5*1.7 ,fig.height=1*7*1.7}
derivative.lsa %>%
filter(focus.title=="\"Growth Function kJ/day\"" ) %>% 
mutate(gender.input=factor(case_when(grepl("M]", focus)~0,
                                   grepl("F]", focus)~1),
                         levels=c(0,1),
                         labels=c("Male", "Female"))) %>% 
filter(gender.input=='Male') %>%
# filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male growth assumptions")+

derivative.lsa %>%
filter(focus.title=="\"Growth Function kJ/day\"" ) %>% 
mutate(gender.input=factor(case_when(grepl("M]", focus)~0,
                                   grepl("F]", focus)~1),
                         levels=c(0,1),
                         labels=c("Male", "Female"))) %>% 
filter(gender.input=='Female') %>%
# filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_blank(),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Female growth assumptions")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Growth function (kJ/day)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.7, face = c("bold")))) & 
theme( legend.position = "bottom")
```

## Macronutrient energy density
Each food group is broken down into macronutrients; carbohydrates, protein, fats and sugars. The energy from a gram of macronutrients is an assumed model input. This assumption impacts each food group for each age-gender-BMI group.

- The input of macronutrients becomes more sensitive for the older age group. This is due to the cumulative impact of the population's life course.
- Higher kJ/g leads to higher daily total dietary intake leading to a higher prevalence of overweight and obesity.
- For every percentage point change in the assumed energy density for dietary fats, there was, on average, a 1.08% increase in the prevalence of obesity in 12 14-year-olds for females and a 1.15% increase for males.
- This effect was 1.98% and 2.72% for 40 44 year olds females and males, respectively.


```{r macro nutrients Kj per gram, echo=F, message=F, error=F, warning=F,  fig.width=1*4*3.2,fig.height=1*2*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="\"NON-SUGAR CARBOHYDRATES Kj per gram\"" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="FATS Kj per gram" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="PROTEIN Kj per gram" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="SUGAR Kj per gram" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, ncol=2, guides = "collect")+
plot_annotation(title = 'Energy density',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```

**Explanation of summary results**
```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
# sensitivity_ran_variables %>% 
#   filter(label=="\"NON-SUGAR CARBOHYDRATES Kj per gram\"")

p.tmp1<-derivative.lsa %>% 
filter(focus.title=="\"NON-SUGAR CARBOHYDRATES Kj per gram\"" ) %>%
# filter(gender.input=='Male' & age.groups.input=="Age 6 8" & bmi.input=="Overweight") %>%
filter(gender.output=='Male') %>%
filter(age.groups.output!="Age 45 49") %>% 
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output), size=1, show.legend = F)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
# facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
# scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                  labels=c("3-5", "18-19", "40-44"))+
scale_x_discrete(breaks=c("Age 2","Age 3 5", "Age 6 8", "Age 9 11", "Age 12 14", "Age 15 17",
                        "Age 18 19", "Age 20 24","Age 25 29", "Age 30 34", "Age 35 39", "Age 40 44"),
               labels=c("2", "3-5", "6-8", "9-11","12-14","15-17","18-19", "20-24", "25-29", "30-34", "35-39","40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
scale_alpha_manual(values=c(0.3,0.3,1), )+
ylab(bquote(atop("Average change in BMI %", "per PP change in input assumption (" *mu[EE]*")")))+
guides(colour = guide_legend("BMI outcomes"), alpha = "none")+
ggtitle("Summary plot - Mean Elementary Effect by age",subtitle="Male outcomes")+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               plot.title = element_text(face = c("bold")),
               plot.subtitle = element_text(),
               strip.text = element_text(size = 7),
               axis.title.y = element_text(size=7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))


p.tmp2<-lsa_bmi_df %>% 
rename("Gender input"="gender.input", "BMI outcome"="bmi.output", "BMI input"="bmi.input", 
     "Age input"="age.groups.input", "Gender outcome"="gender.output", "Age output"="age.groups.output") %>%
filter(focus.title=="\"NON-SUGAR CARBOHYDRATES Kj per gram\"" ) %>%
# filter(`Gender input`=='Male') %>%
filter(`Gender outcome`=='Male') %>%
filter(`BMI outcome`=="With obesity") %>% 
# filter(`BMI input`=="Overweight" ) %>% 
# filter(`Age input`=="Age 6 8") %>%
filter(`Age output`!="Age 45 49") %>%
ggplot()+
# geom_point(aes(x=prop-100, y=`2057`), color=hue_pal()(3)[3], size=0.4)+
geom_smooth(aes(x=prop-100, y=`2057`), se=F, linewidth=0.5, color=hue_pal()(3)[3], span=0.25)+
# geom_line(aes(x=input.value, y=diff, color=scenario))+
# geom_line(aes(x=input.value, y=base.model.value), linetype="dashed")+
geom_vline(aes(xintercept=0, color="Initial assumption"), linetype="dashed", alpha=0.3)+
facet_wrap(vars(`Age output`), ncol = 4, nrow=3)+
scale_colour_manual(values = c("black"))+
guides(colour = guide_legend(" "))+
scale_y_continuous(labels = scales::percent)+
# scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
#                  limits = c(-20, 20))+
scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
                 limits = c(-20, 20),
                 sec.axis = sec_axis(~(.+100)*16.7/100,
                                     name = "\n Energy density (kJ/g) \n",
                                     labels =scales::label_number(suffix = "kJ/g")))+
ylab("Prevalence of obesity")+
xlab("\n Percentage of initial assumed energy density for Carbohydrates (kJ/g)")+
ggtitle("Individual relationships", subtitle = "Prevalence of obesity vs assumed energy density for Carbohydrates (kJ/g)")+
theme_bw() +theme(legend.position = "bottom",
                  panel.spacing.y =unit(0, "mm"),
                  panel.spacing.x =unit(4, "mm"),
                  plot.title = element_text(face = c("bold")),
                  plot.subtitle = element_text())

layout <- '
#AAAAA#
BBBBBBB
BBBBBBB
'
wrap_plots(A = p.tmp1, B = p.tmp2, design = layout, tag_level = "keep")+
# plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")
```


## Thermic effect of food (TEF)
The thermic effect of food (TEF) is the proportion of the energy used for digestion. A higher TEF means less dietary energy is available after digestion. TEF input assumptions impact the whole population, translating to a highly sensitivity input assumption.

- Change in TEF, cumulative over the life course leading to a higher impact for older age groups.
- 1 percentage point (0.0015 TEF units) increase in the **TEF of carbohydrate** results in a -0.06 to -0.52% change in obesity.
- -0.44 to -3.51% change in obesity per 0.01 TEF. 
- 1 percentage point (0.0015 TEF units) increase in the **TEF of Fat** results in a -0.07 to -0.59% change in obesity.
- -0.48 to -3.99% change in obesity per 0.01 TEF. 
- 1 percentage point (0.002 TEF units) increase in the **TEF of Protein** results in a -0.06 to -0.49% change in obesity.
- -0.30 to -2.45% change in obesity per 0.01 TEF. 
- 1 percentage point (0.0007 TEF units) increase in the **TEF of Sugar** results in a -0.03 to -0.27% change in obesity.
- -0.43 to -3.90% change in obesity per 0.01 TEF.

```{r TEF, echo=F, message=F, error=F, warning=F,  fig.width=1*4*3.2,fig.height=1*2*3.2}

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="CARBOHYDRATE TEF" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="FATS TEF" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="PROTEIN TEF" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="SUGAR TEF" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=8),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, ncol=2, guides = "collect")+
plot_annotation(title = 'Thermic Effect of Food (TEF)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```

**Explanation of summary results**
```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
# sensitivity_ran_variables %>%
#   filter(grepl("TEF", label))
```


```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
p.tmp1<-derivative.lsa %>% 
filter(focus.title=="PROTEIN TEF" ) %>%
# filter(gender.input=='Male' & age.groups.input=="Age 6 8" & bmi.input=="Overweight") %>%
filter(gender.output=='Male') %>%
filter(age.groups.output!="Age 45 49") %>% 
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output), size=1, show.legend = F)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
# facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
# scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                  labels=c("3-5", "18-19", "40-44"))+
scale_x_discrete(breaks=c("Age 2","Age 3 5", "Age 6 8", "Age 9 11", "Age 12 14", "Age 15 17",
                        "Age 18 19", "Age 20 24","Age 25 29", "Age 30 34", "Age 35 39", "Age 40 44"),
               labels=c("2", "3-5", "6-8", "9-11","12-14","15-17","18-19", "20-24", "25-29", "30-34", "35-39","40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
scale_alpha_manual(values=c(1,1,1), )+
ylab(bquote(atop("Average change in BMI %", "per PP change in input assumption (" *mu[EE]*")")))+
guides(colour = guide_legend("BMI outcomes"), alpha = "none")+
ggtitle("Summary plot - Mean Elementary Effect by age",subtitle="Male outcomes")+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               plot.title = element_text(face = c("bold")),
               plot.subtitle = element_text(),
               strip.text = element_text(size = 7),
               axis.title.y = element_text(size=7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))


p.tmp2<-lsa_bmi_df %>% 
rename("Gender input"="gender.input", "BMI outcome"="bmi.output", "BMI input"="bmi.input", 
     "Age input"="age.groups.input", "Gender outcome"="gender.output", "Age output"="age.groups.output") %>%
filter(focus.title=="PROTEIN TEF" ) %>%
# filter(`Gender input`=='Male') %>%
filter(`Gender outcome`=='Male') %>%
# filter(`BMI outcome`=="With obesity") %>% 
# filter(`BMI input`=="Overweight" ) %>% 
# filter(`Age input`=="Age 6 8") %>%
filter(`Age output`!="Age 45 49") %>%
ggplot()+
# geom_point(aes(x=prop-100, y=`2057`), color=hue_pal()(3)[3], size=0.4)+
geom_smooth(aes(x=prop-100, y=`2057`, color=`BMI outcome`), se=F, linewidth=0.5, span=0.25)+
# geom_line(aes(x=input.value, y=diff, color=scenario))+
# geom_line(aes(x=input.value, y=base.model.value), linetype="dashed")+
# geom_vline(aes(xintercept=0, color="Initial assumption"), linetype="dashed", alpha=0.3)+
facet_wrap(vars(`Age output`), ncol = 4, nrow=3)+
scale_colour_manual(values = c(hue_pal()(3)))+
guides(colour = guide_legend(" "))+
scale_y_continuous(labels = scales::percent)+
# scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
#                  limits = c(-20, 20))+
scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
                 limits = c(-20, 20),
                 sec.axis = sec_axis(~(.+100)*0.2/100,
                                     name = "\n TEF \n",
                                     labels =scales::label_number(suffix = "")))+
ylab("BMI Prevalence")+
xlab(" \n Percentage of initial assumed Thermic Effect of Food (TEF) for Protein")+
ggtitle("Individual relationships", subtitle = "Male outcomes vs assumed Thermic Effect of Food (TEF) for Protein")+
theme_bw() +theme(legend.position = "bottom",
                  panel.spacing.y =unit(0, "mm"),
                  panel.spacing.x =unit(4, "mm"),
                  plot.title = element_text(face = c("bold")),
                  plot.subtitle = element_text())

layout <- '
##AAAA##
BBBBBBBB
BBBBBBBB
'
wrap_plots(A = p.tmp1, B = p.tmp2, design = layout, tag_level = "keep")+
# plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")
```


## Adult to Adult Social Transmission
Adult to Adult social transmission assumptions impact how changes in physical activity (PAL) and dietary behaviours are transmitted to other adults through role modelling. This assumption has little impact on the output. However, because this variable is dependent on change of behaviour, role-modelling likely interactions with intervention effects.

```{r Adult to Adult Social Transmission, echo=F, message=F, error=F, warning=F,  fig.width=1*3*2.7,fig.height=1*2.7*2.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Adult to Adult Social Transmission of DIET Behaviors" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Adult to Adult Social Transmission of dietary Behaviors")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Adult to Adult Social Transmission of PAL Behaviors" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Adult to Adult Social Transmission of physical Behaviors")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, guides = "collect") +
plot_annotation(title = 'Adult to Adult Role Modelling',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")

```


## Adult to Child Social Transmission
Similar to "Adult to Adult" role-modelling, BMI outcome has little impact when Adult to Child role-modelling assumptions are varied.

```{r Adult to Child Social Transmission, echo=F, message=F, error=F, warning=F, fig.width=1*3*2.7,fig.height=1*2.7*2.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Adult to Child Social Transmission DIET Behaviors" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Adult to Child Social Transmission of dietary Behaviors")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Adult to Child Social Transmission PAL Behaviors" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Adult to Child Social Transmission of physical Behaviors")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, guides = "collect") +
plot_annotation(title = 'Adult to Child Role Modelling',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```

## Child to Child Social Transmission
Similar to "Adult to Adult" role-modelling, BMI outcome has little impact when Child to Child role-modelling assumptions are varied. These assumptions interact with intervention assumptions.

```{r Child to Child Social Transmission, echo=F, message=F, error=F, warning=F, fig.width=1*3*2.7,fig.height=1*2.7*2.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Child to Child Social Transmission of DIET Behavior" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Child to Child Social Transmission of dietary Behaviors")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Child to Child Social Transmission of PAL Behaviors" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Child to Child Social Transmission of physical Behaviors")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, guides = "collect") +
plot_annotation(title = 'Child to Child Role Modelling',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```


## Infant Reported behaviours
The assumed reported infant behaviours amplify the intergenerational effects. However, these impacts are minimal.

- The proportion of mother that breastfeed impact older age groups. This is because of the increase in energy expenditure caused by breastfeeding. 
- The proportion of infants that consume non-core foods and TV for more than 1 hr/day impacts younger age groups. Higher non-core food consumption and greater TV viewing increase the prevalence of overweight and obesity.


```{r Infant Reported behaviours, echo=F, message=F, error=F, warning=F, fig.width=1.2*2*3.5,fig.height=1*3*3.5}

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="\"Percentage BF >6mths reported\"" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Percentage of mothers breastfeeding to 6 months")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="\"Percentage non-core > 0 reported\"" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Percentage of infants consuming non-core foods")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="\"Percentage TV >1 per day reported\"" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Percentage of infants watching TV more than 1 hr/day")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 3, ncol=1, guides = "collect") +
plot_annotation(title = 'Infant behaviours',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")
```



## Assumed intergenerational relationships
```{r Intergenerational OR effects, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.5,fig.height=1*5*3.5}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Intercept" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Parents BMI" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per 0.01 odds ratio (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Impact of parents BMI on infants weight")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Breastfeeding >=6mth" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Impact of breastfeeding on infants weight")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="TV >=1" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Impact of TV on infants weight")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Non-core >0" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Impact of non-core foods on infants weight")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") +
plot_annotation(title = 'Logistic regression odds ratio',subtitle = "Odds of overweight or obesity at 2 years",
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) & 
theme(legend.position = "bottom")

```


## Mortality ratios
Hazard ratios are applied to exogenous mortality rate so predicted population dynamics are maintained. 

- Changing these assumptions impact older age group, primarily cause by higher mortality rates in these age groups.
- Since the primary outcome is a percentage, these ratio have little impact. 

```{r Mortality ratios, echo=F, message=F, error=F, warning=F, fig.width=1*3*2.7,fig.height=1*2*2.7}
derivative.lsa %>%
filter(focus.title=="BMI Hazards Ratios" ) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`BMI input`), rows = vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Hazards Ratios")+
labs(caption = "*Percentage point (PP)")+
plot_annotation(title = 'Mortality',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")


```

## METs
Duration and intensive (METs) of physical activity are used to estimate total energy expenditure. The assumed METs for each movement category are applied to all of the population, which results in highlight sensitivity input assumptions.

- Impact from variations in METs assumptions accumulate over the population's life course, resulting in higher impacts for older age groups.
- Increase in MET implies that each movement activity has higher intensity leading to a healthier population.
- 1 percentage point increase in **sleep METs** results in a between -0.15% to -2.83% change in obesity.
- 1 percentage point increase in **inactive METs** results in a between -0.14% to -2.81% change in obesity.
- 1 percentage point increase in **screen time METs** results in a between -0.11% to -2.36% change in obesity.
- 1 percentage point increase in **light physical activity METs** results in a between -0.08% to -1.63% change in obesity.
- 1 percentage point increase in **moderate physical activity METs** results in a between -0.08% to -0.99% change in obesity.
- 1 percentage point increase in **vigorous physical activity METs** results in a between 1.88% to 29.19% change in obesity.

```{r METs, echo=F, message=F, error=F, warning=F, fig.width=1*4*3.2,fig.height=1*3*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="INACTIVE METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Inactivity")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="SCREEN TIME METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Screen time")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="SLEEP METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Sleep")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="LIGHT PA METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Light physical activity")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="MODERATE PA METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Moderate physical activity")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="VIGOROUS PA METs") %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("METs - Vigorous physical activity")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=2, nrow = 3, guides = "collect") +
plot_annotation(title = 'Metabolic Equivelence of Task (MET)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) & 
theme(legend.position = "bottom")
```

**Explanation of summary results**
```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
# sensitivity_ran_variables %>%
#   filter(label=="VIGOROUS PA METs")

p.tmp1<-derivative.lsa %>% 
filter(focus.title=="VIGOROUS PA METs") %>%
# filter(gender.input=='Male' & age.groups.input=="Age 6 8" & bmi.input=="Overweight") %>%
filter(gender.output=='Male') %>%
filter(age.groups.output!="Age 45 49") %>% 
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output), size=1, show.legend = F)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
# facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
# scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                  labels=c("3-5", "18-19", "40-44"))+
scale_x_discrete(breaks=c("Age 2","Age 3 5", "Age 6 8", "Age 9 11", "Age 12 14", "Age 15 17",
                        "Age 18 19", "Age 20 24","Age 25 29", "Age 30 34", "Age 35 39", "Age 40 44"),
               labels=c("2", "3-5", "6-8", "9-11","12-14","15-17","18-19", "20-24", "25-29", "30-34", "35-39","40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
scale_alpha_manual(values=c(0.3,0.3,1), )+
ylab(bquote(atop("Average change in BMI %", "per PP change in input assumption (" *mu[EE]*")")))+
guides(colour = guide_legend("BMI outcomes"), alpha = "none")+
ggtitle("Summary plot - Mean Elementary Effect by age",subtitle="Male outcomes")+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               plot.title = element_text(face = c("bold")),
               plot.subtitle = element_text(),
               strip.text = element_text(size = 7),
               axis.title.y = element_text(size=7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))


p.tmp2<-lsa_bmi_df %>% 
rename("Gender input"="gender.input", "BMI outcome"="bmi.output", "BMI input"="bmi.input", 
     "Age input"="age.groups.input", "Gender outcome"="gender.output", "Age output"="age.groups.output") %>%
filter(focus.title=="VIGOROUS PA METs") %>%
# filter(`Gender input`=='Male') %>%
filter(`Gender outcome`=='Male') %>%
filter(`BMI outcome`=="With obesity") %>% 
# filter(`BMI input`=="Overweight" ) %>% 
# filter(`Age input`=="Age 6 8") %>%
filter(`Age output`!="Age 45 49") %>%
ggplot()+
# geom_point(aes(x=prop-100, y=`2057`), color=hue_pal()(3)[3], size=0.4)+
geom_smooth(aes(x=prop-100, y=`2057`), se=F, linewidth=0.5, color=hue_pal()(3)[3], span=0.25)+
# geom_line(aes(x=input.value, y=diff, color=scenario))+
# geom_line(aes(x=input.value, y=base.model.value), linetype="dashed")+
geom_vline(aes(xintercept=0, color="Initial assumption"), linetype="dashed", alpha=0.3)+
facet_wrap(vars(`Age output`), ncol = 4, nrow=3)+
scale_colour_manual(values = c("black"))+
guides(colour = guide_legend(" "))+
scale_y_continuous(labels = scales::percent)+
# scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
#                  limits = c(-20, 20))+
scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
                 limits = c(-20, 20),
                 sec.axis = sec_axis(~(.+100)*6/100,
                                     name = "\n MET \n",
                                     labels =scales::label_number(suffix = "")))+
ylab("Prevalence of obesity")+
xlab(" \n Percentage of initial assumed Metabolic Equivelence of Task (MET) for vigorous activity")+
ggtitle("Individual relationships", subtitle = "Prevalence of obesity vs assumed Metabolic Equivelence of Task (MET) for vigorous activity")+
theme_bw() +theme(legend.position = "bottom",
                  panel.spacing.y =unit(0, "mm"),
                  panel.spacing.x =unit(4, "mm"),
                  plot.title = element_text(face = c("bold")),
                  plot.subtitle = element_text())

layout <- '
#AAAAA#
BBBBBBB
BBBBBBB
'
wrap_plots(A = p.tmp1, B = p.tmp2, design = layout, tag_level = "keep")+
# plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")
```


## Light physical activity

Each behaviour is structured so that they are age dependent; observed surveyed behaviours were modelled using linear regression with age groups as the independent variable. This creates two variables for each behaviour; the intercept is the level of behaviour at the youngest age group (2 years old) and the change of behaviours over the life course.

- Changes in the intercept assumptions have cumulative impacts over the life course, resulting in higher impacts in older age groups compared to younger age groups.
- Varying age-on-age (AGE SLOPE) changes the trajectory of behaviours over the life course, making older age group BMI outcomes sensitive to changes in age slope.

```{r LIGHT PA, echo=F, message=F, error=F, warning=F, fig.width=10, fig.height=10}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily LIGHT PA minutes Reported INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Light physical activity - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily LIGHT PA minutes Reported AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Light physical activity - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily light physical activity minutes',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Moderate physical activity
```{r MODERATE PA, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily MODERATE PA minutes Reported INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moderate physical activity - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily MODERATE PA minutes Reported AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moderate physical activity - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily moderate physical activity minutes',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Vigorous physical activity
```{r VIGOROUS PA, echo=F, message=F, error=F, warning=F,  fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily VIGOROUS PA minutes Reported INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Vigorous physical activity - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily VIGOROUS PA minutes Reported AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Vigorous physical activity - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily vigorous physical activity minutes',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Screen time
```{r SCREEN TIME, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily SCREEN TIME minutes Reported INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Screen time - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily SCREEN TIME minutes Reported AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Screen time - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily screen time minutes',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")
```

## Sleep
```{r SLEEP, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily SLEEP minutes Reported INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sleep - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Daily SLEEP minutes Reported AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sleep - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily minutes of sleep',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Fruit Reported Intake
```{r Fruit Reported Intake, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Fruit Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Fruit consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Fruit Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Fruit consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of fruit',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Vegetables Reported Intake
```{r Vegetables Reported Intake, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Vegetables Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Vegetable consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Vegetables Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Vegetable consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of vegetables',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Grains Reported Intake
```{r Grains Reported Intake, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Grains Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Grain consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Grains Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Grain consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of grains',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")
```

## Dairy Reported Intake
```{r Dairy Reported Intake, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Dairy Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dairy consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Dairy Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dairy consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of dairy',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Meat and Protein Reported
```{r Meat and Protein Reported, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Meat and Protein Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Meat and protein consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Meat and Protein Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Meat and protein consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of meat and protein',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")


```

## Discretionary foods Reported
```{r Discretionary foods Reported, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Discretionary foods Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Discretionary consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Discretionary foods Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Discretionary consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of discretionary',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Fats and Oils Reported
```{r Fats and Oils Reported, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Fats and Oils Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Fats and Oils consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Fats and Oils Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Fats and Oils consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of Fats and Oils',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")


```

## Sugar based beverage Reported
```{r Sugar based beverage Reported, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Sugar based beverage Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugar based beverage consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Sugar based beverage Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugar based beverage consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of sugar based beverage',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")


```

## Water Reported
```{r Water Reported, echo=F, message=F, error=F, warning=F, fig.width=1*6*1.7,fig.height=1*6*1.7}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Water Reported Intake INTERCEPT" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Water consumption - Intercept")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "Gender input"="gender.input",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus.title=="Water Reported Intake AGE SLOPE" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# facet_grid(col=vars(gender.output, bmi.input), rows = vars(`Gender input`), scale="free")+
facet_grid2(col=vars(`Gender outcome`, `BMI input`), rows = vars(`Gender input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Water consumption - Age change")+
labs(caption = "*Percentage point (PP)")+

plot_layout(ncol=1, nrow = 2, guides = "collect") +
plot_annotation(title = 'Daily consumption of water',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")),
                             plot.subtitle = element_text(size = 12, hjust = 0.5))) &
theme(legend.position = "bottom")

```

## Initial fat-mass (%)
**Change in Male fat-mass % assumptions**
```{r Initial FM Male, echo=F, message=F, error=F, warning=F,  fig.width=1*6.3*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="Initial FM %" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
  scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="Initial FM %" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Male initial fat-mass %',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")
```

**Change in Female fat-mass % assumptions**
```{r Initial FM Female, echo=F, message=F, error=F, warning=F,  fig.width=1*6.3*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="Initial FM %" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1))+
  scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="Initial FM %" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
# scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Change in BMI", "per m increase in height (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Female initial fat-mass %',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")
```



##  Proportion of nutrients within food group Inputs     
**Grains**
```{r Prop of nutrients within food group Grains, echo=F, message=F, error=F, warning=F,  fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Grains]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Grains]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Grains]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Grains]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Grains]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within grains',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Vegetables**
```{r Prop of nutrients within food group vegetable, echo=F, message=F, error=F, warning=F,  fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Vegetables]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Vegetables]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Vegetables]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Vegetables]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Vegetables]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within vegetables',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")
```

**Fruit**
```{r Prop of nutrients within food group Fruit, echo=F, message=F, error=F, warning=F,  fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Fruit]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Fruit]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Fruit]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Fruit]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Fruit]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within fruit',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")
```


**Dairy**
```{r Prop of nutrients within food group Dairy, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Dairy]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Dairy]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Dairy]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Dairy]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Dairy]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
             axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within dairy',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Meat and Protein**
```{r Prop of nutrients within food group Meat, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Meat]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Meat]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Meat]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Meat]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Meat]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within meat and protein',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")

```

**Fats**
```{r Prop of nutrients within food group Fats, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
# derivative.lsa %>%
#   rename("Gender outcome"="gender.output",
#          "BMI input"="bmi.input",
#          "Age input"="age.groups.input") %>% 
#   filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Fats]" ) %>%
#   ggplot()+
#   geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
#   geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
#   facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
#   scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                    labels=c("3-5", "18-19", "40-44"))+
#   scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
#   # scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
#   xlab("Age outcomes")+
#   ylab(bquote(atop("Average change in BMI %", "per percentage point (" *mu[EE]*")")))+
#   theme_bw()+theme(legend.position = "bottom",
#                    panel.spacing=unit(0, "mm"),
#                    strip.text = element_text(size = 7),
#                    axis.text.x = element_text(size=6),
#                    axis.text.y = element_text(size=8))+
#   guides(colour = guide_legend("BMI outcomes"))+
#   ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Fats]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Fats]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Fats]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Fats]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 4, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within fats and oil',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Discretionary foods**
```{r Prop of nutrients within food group Discretionary_foods, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Discretionary_foods]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Discretionary_foods]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Discretionary_foods]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Discretionary_foods]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Discretionary_foods]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within discretionary food',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Sugar-sweetened beverages**
```{r Prop of nutrients within food group Sugar_Sweetened_beverage, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*2*3.2}
# derivative.lsa %>%
#   rename("Gender outcome"="gender.output",
#          "BMI input"="bmi.input",
#          "Age input"="age.groups.input") %>%
#   filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Sugar_Sweetened_beverage]" ) %>%
#   ggplot()+
#   geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
#   geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
#   facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
#   scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                    labels=c("3-5", "18-19", "40-44"))+
#   scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
#   # scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
#   xlab("Age outcomes")+
#   ylab(bquote(atop("Average change in BMI %", "per percentage point (" *mu[EE]*")")))+
#   theme_bw()+theme(legend.position = "bottom",
#                    panel.spacing=unit(0, "mm"),
#                    strip.text = element_text(size = 7),
#                    axis.text.x = element_text(size=6),
#                    axis.text.y = element_text(size=8))+
#   guides(colour = guide_legend("BMI outcomes"))+
#   ggtitle("Carbohydrates")+
#   
#   derivative.lsa %>%
#   rename("Gender outcome"="gender.output",
#          "BMI input"="bmi.input",
#          "Age input"="age.groups.input") %>% 
#   filter(focus=="Proportion of nutrients within food group Inputs[Fats, Sugar_Sweetened_beverage]" ) %>%
#   ggplot()+
#   geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
#   geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
#   facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
#   scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                    labels=c("3-5", "18-19", "40-44"))+
#   scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
#   # scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
#   xlab("Age outcomes")+
#   ylab(bquote(atop("Average change in BMI %", "per percentage point (" *mu[EE]*")")))+
#   theme_bw()+theme(legend.position = "bottom",
#                    panel.spacing=unit(0, "mm"),
#                    strip.text = element_text(size = 7),
#                    axis.text.x = element_text(size=6),
#                    axis.text.y = element_text(size=8))+
#   guides(colour = guide_legend("BMI outcomes"))+
#   ggtitle("Dietary fats")+
#   
#   derivative.lsa %>%
#   rename("Gender outcome"="gender.output",
#          "BMI input"="bmi.input",
#          "Age input"="age.groups.input") %>% 
#    filter(focus=="Proportion of nutrients within food group Inputs[Protein, Sugar_Sweetened_beverage]" ) %>%
#   ggplot()+
#   geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
#   geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
#   facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
#   scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                    labels=c("3-5", "18-19", "40-44"))+
#   scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
#   # scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
#   xlab("Age outcomes")+
#   ylab(bquote(atop("Average change in BMI %", "per percentage point (" *mu[EE]*")")))+
#   theme_bw()+theme(legend.position = "bottom",
#                    panel.spacing=unit(0, "mm"),
#                    strip.text = element_text(size = 7),
#                    axis.text.x = element_text(size=6),
#                    axis.text.y = element_text(size=8))+
#   guides(colour = guide_legend("BMI outcomes"))+
#   ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Sugar_Sweetened_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Sugar_Sweetened_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 2, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within \n sugar-sweetened beverages',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Miscellaneous (Other)**
```{r Prop of nutrients within food group Other, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, Other]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, Other]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, Other]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, Other]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, Other]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within miscellaneous (Other)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.6, face = c("bold")))) & 
theme(legend.position = "bottom")


```

**Non-sugar-sweetened beverages**
```{r Prop of nutrients within food group NonAlcoholic_beverage, echo=F, message=F, error=F, warning=F, fig.width=1*2*3.2,fig.height=1*5*3.2}
derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%
filter(focus=="Proportion of nutrients within food group Inputs[Carbohydrates, NonAlcoholic_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Carbohydrates")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Fats, NonAlcoholic_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Dietary fats")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Protein, NonAlcoholic_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Protein")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Sugars, NonAlcoholic_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Sugars")+

derivative.lsa %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
filter(focus=="Proportion of nutrients within food group Inputs[Moisture, NonAlcoholic_beverage]" ) %>%
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`Gender outcome`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.1))+
# scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Moisture")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 5, ncol=1, guides = "collect") + 
plot_annotation(title = 'Percentage of macro-nutrients within beverage (Non-SSB)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")

```

## Initial BMI Prevalence Inputs
**Change in Male Initial BMI Prevalence**

```{r Body Male Initial BMI Prevalence, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="Initial BMI Prevalence Inputs" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="Initial BMI Prevalence Inputs" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>%   
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Male Initial BMI Prevalence',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```

**Change in Female Initial BMI Prevalence**
```{r Body Female Initial BMI Prevalence, echo=F, message=F, error=F, warning=F, fig.width=1.2*6*1.5,fig.height=1*12*1.5}
derivative.lsa %>%
filter(focus.title=="Initial BMI Prevalence Inputs" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes")+

derivative.lsa %>%
filter(focus.title=="Initial BMI Prevalence Inputs" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
# filter(as.numeric(age.groups.input)<=6) %>%   
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = label_scientific( scale =1,suffix = "%"))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in BMI %", "per PP* change in input assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               axis.title.y = element_text(size=9),
               strip.text = element_text(size = 7))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes")+
labs(caption = "*Percentage point (PP)")+

plot_layout(nrow = 1, ncol=2, guides = "collect") + 
plot_annotation(title = 'Female Initial BMI Prevalence',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")
```


# Plots for thesis chapter

## Explaination
```{r, echo=F, message=FALSE, warning=F, error=F, fig.height=1*1*5, fig.width=1.1*2*5, fig.cap="Example plot for analysis outcome"}
cc <- scales::seq_gradient_pal("blue", "red", "Lab")(seq(0,1,length.out=6))
x2=0
x3=0.02

data.frame(x=seq(0,50, 0.1)) %>% 
mutate(`Base model`=(0.3/(1+exp(-(1/10)*(x-15))))) %>% 
mutate(int.effect1=ifelse(x>0,`Base model`*(1-((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect2=ifelse(x>0,`Base model`*(1-((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect3=ifelse(x>0,`Base model`*(1-((x2-x3*3))/(1+exp(-1*(0)))), NA)) %>% 
mutate(`Initial assumptions`=ifelse(x>15,`Base model`*(1+((x2))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect5=ifelse(x>0,`Base model`*(1+((x2-x3*3))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect6=ifelse(x>0,`Base model`*(1+((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect7=ifelse(x>0,`Base model`*(1+((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
gather(., type,y,`Base model`:int.effect7) %>% 
mutate(type=factor(case_when(type=="Base model"~1,
                     type=="Initial assumptions"~2,
                    type=="int.effect1"~3,
                    type=="int.effect2"~4,
                    type=="int.effect3"~5,
                    type=="int.effect5"~6,
                    type=="int.effect6"~7,
                    type=="int.effect7"~8),
                  levels=c(1,2,3,4,5,6,7,8),
     labels=c("Base model", "Initial assumptions",
                           paste0("x=",sprintf("%0.1f",-20)),paste0("x=",sprintf("%0.1f",-13)),paste0("x=",sprintf("%0.1f",-6)),
                         paste0("x=",sprintf("%0.1f",6)),paste0("x=",sprintf("%0.1f",13)),paste0("x=",sprintf("%0.1f",20))))) %>%  
mutate(y.point=ifelse(x==50, y, NA)) %>%
ggplot()+
geom_point(aes(x=x, y=y.point,  fill=type), shape=21)+
geom_line(aes(x=x, y=y, color=type, linetype=type), show.legend = F)+
scale_y_continuous(limits = c(0, 0.35), label=scales::percent)+
scale_fill_manual(values=c("black", "grey", cc))+
scale_color_manual(values=c("black", "black", cc))+
scale_linetype_manual(values=c(1,1, rep(2, 6)))+
theme_bw()+
guides(fill = guide_legend("Model run"),
     linetype = guide_legend("Model run"))+
ylab("Model-generated outcome \n BMI prevalence (%)")+xlab("Modelled time")+
theme(legend.position = "bottom")+
ggtitle("Outcome")+

data.frame(x=seq(0,50, 0.1)) %>% 
mutate(`Base model`=(0.3/(1+exp(-(1/10)*(x-15))))) %>% 
mutate(int.effect1=ifelse(x>0,`Base model`*(1+((x2-x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect2=ifelse(x>0,`Base model`*(1+((x2-x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect3=ifelse(x>0,`Base model`*(1+((x2-x3*3))/(1+exp(-1*(0)))), NA)) %>% 
mutate(`Initial assumptions`=ifelse(x>15,`Base model`*(1+((x2))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect5=ifelse(x>0,`Base model`*(1+((x2+x3*3))/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect6=ifelse(x>0,`Base model`*(1+((x2+x3*6))*0.9/(1+exp(-1*(x-0)))), NA)) %>% 
mutate(int.effect7=ifelse(x>0,`Base model`*(1+((x2+x3*9))*0.65/(1+exp(-1*(x-0)))), NA)) %>% 
gather(., type,y,`Base model`:int.effect7) %>% 
mutate(type.num=case_when(type=="Initial assumptions"~x2,
                    type=="int.effect1"~x2-x3*9,
                    type=="int.effect2"~x2-x3*6,
                    type=="int.effect3"~x2-x3*3,
                    type=="int.effect5"~x2+x3*3,
                    type=="int.effect6"~x2+x3*6,
                    type=="int.effect7"~x2+x3*9)) %>% 
filter(x==50) %>% 
filter(type!="Base model") %>% 
mutate(type.color=c("-20%", "-13%", "-6%", "0%", "6%", "13%", "20%")) %>% 
ggplot()+
# geom_line(aes(x=type.num, y=y), stat = "smooth", alpha=0.1, method="loess")+
geom_line(aes(x=type.num, y=y), alpha=0.1)+
scale_y_continuous(limits = c(0.25, 0.33), label=scales::percent)+
scale_x_continuous(breaks=c(-0.18, -0.12, -0.06, 0.000, 0.06, 0.12, 0.18),
                 labels = c("-20%", "-13%", "-6%", "Initial assumptions", "6%", "13%", "20%"))+
scale_fill_manual(values=c("#0000FF", "#8D00CE", "#BA009F", "grey", "#D70072", "#ED0044", "#FF0000"))+
ggbrace::geom_brace(aes(x=c(0, 0+0.007), y=c(0.2912063-0.001,0.2822063-0.001)),rotate=90, inherit.data=F)+
ggbrace::geom_brace(aes(x=c(-0.06,0), y=c(0.2822063-0.002, 0.2822063-0.002-0.003)),rotate=180, inherit.data=F)+
annotate("text", x = 0.04, y = 0.285, parse = T, label = as.character(expression("f("*x*"+"*Delta*")-f(x)")))+
annotate("text", x = -0.062+(0.06-0)/2, y = 0.275, parse = T, label = as.character(expression(~Delta)))+
annotate("text", x =-0.062+(0.06-0)/2, y = 0.275-0.015, parse = T, label = as.character(expression(paste(EE," = ",frac("f(x+"*Delta*")-f(x)", ~Delta)))))+
geom_point(aes(x=type.num, y=y, fill=type.color), shape=21)+
theme_bw()+
guides(fill = guide_legend("Model run"))+
ylab("Model-generated outcome \n BMI prevalence (%)")+xlab("Percentage of initial input assumptions")+
theme(legend.position = "bottom")+
ggtitle("Outcome at the time 50")+


plot_layout(ncol=2, nrow=1)+
plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")

```

## Males body weight 2 - 18 year olds
```{r Body Weight Male chapter plot, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*7*1.5}
tmp.p1<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
filter(as.numeric(age.groups.input) %in% c(1,2,3,4)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-2,2))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes", subtitle="Children")

tmp.p2<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Male') %>%
filter(as.numeric(age.groups.input) %in% c(5,6)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-2,2))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes", subtitle="Adolscents")

tmp.p3<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
filter(as.numeric(age.groups.input) %in% c(1,2,3,4)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-0.1, 0.1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes", subtitle="Children")


tmp.p4<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Male') %>%
filter(gender.output=='Female') %>%
filter(as.numeric(age.groups.input) %in% c(5,6)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-0.1, 0.1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes", subtitle="Adolscents")+
labs(caption = "*Percentage point (PP)")

tmp.p1+tmp.p3+tmp.p2+tmp.p4+
plot_layout(nrow = 3, ncol=2, guides = "collect",
          design = "
          12
          12
          34
          ") + 
plot_annotation(title = 'Male Body Weight (kg)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme(legend.position = "bottom")


```
## Female body weight including 20-24 and 40-44

```{r Body Weight Female for chapter, echo=F, message=F, error=F, warning=F,  fig.width=1.2*6*1.5,fig.height=1*9*1.5}
tmp.p1<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
filter(as.numeric(age.groups.input) %in% c(1,2,3,4)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-0.1, 0.1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes", subtitle="Children")

tmp.p2<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
filter(as.numeric(age.groups.input) %in% c(5,6)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-0.1, 0.1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes", subtitle="Adolscents")

tmp.p3<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Male') %>%
filter(as.numeric(age.groups.input) %in% c(8,12)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-0.1, 0.1))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Male outcomes", subtitle="Select adults ages")

tmp.p4<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
filter(as.numeric(age.groups.input) %in% c(1,2,3,4)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-2, 2))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes", subtitle="Children")

tmp.p5<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
filter(as.numeric(age.groups.input) %in% c(5,6)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-2, 2))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes", subtitle="Adolscents")


tmp.p6<-derivative.lsa %>%
filter(focus.title=="\"Body Weight (kg)\"" ) %>%
filter(gender.input=='Female') %>%
filter(gender.output=='Female') %>%
filter(as.numeric(age.groups.input) %in% c(8,12)) %>%
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>%   ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output), size=1)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
               labels=c("3-5", "18-19", "40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01), limits = c(-2, 2))+
xlab("Age outcomes")+
ylab(bquote(atop("Average change in prevalence", "per PP* increase in body weight assumption (" *mu[EE]*")")))+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               strip.text = element_text(size = 7),
               axis.title.y = element_blank(),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))+
guides(colour = guide_legend("BMI outcomes"))+
ggtitle("Females outcomes", subtitle="Select adults ages")+
labs(caption = "*Percentage point (PP)")

tmp.p1+tmp.p4+tmp.p2+tmp.p5+tmp.p3+tmp.p6+
plot_layout(nrow = 3, ncol=2, guides = "collect",
          design = "
          12
          12
          34
          56
          ") + 
plot_annotation(title = 'Female Body Weight (kg)',
               theme = theme(plot.title = element_text(size = 16, hjust = 0.5, face = c("bold")))) & 
theme( legend.position = "bottom")
```

### TEF
```{r, echo=F, message=F, error=F, warning=F,  fig.width=1*4*2.2,fig.height=1*4.5*2.2}
p.tmp1<-derivative.lsa %>% 
filter(focus.title=="PROTEIN TEF" ) %>%
# filter(gender.input=='Male' & age.groups.input=="Age 6 8" & bmi.input=="Overweight") %>%
filter(gender.output=='Male') %>%
filter(age.groups.output!="Age 45 49") %>% 
# filter(as.numeric(age.groups.input)<=6) %>% 
rename("Gender outcome"="gender.output",
     "BMI input"="bmi.input",
     "Age input"="age.groups.input") %>% 
ggplot()+
geom_point(aes(x=age.groups.output, y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output), size=1, show.legend = F)+
geom_line(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output, alpha=bmi.output))+
# geom_smooth(aes(x=as.numeric(age.groups.output), y=mean.ee.prop.alt, color=bmi.output), se=F, linewidth=0.5)+
# facet_grid2(col=vars(`BMI input`), rows = vars(`Age input`), scale="free", labeller = label_both, independent = "x")+
# scale_x_discrete(breaks=c("Age 3 5", "Age 18 19", "Age 40 44"),
#                  labels=c("3-5", "18-19", "40-44"))+
scale_x_discrete(breaks=c("Age 2","Age 3 5", "Age 6 8", "Age 9 11", "Age 12 14", "Age 15 17",
                        "Age 18 19", "Age 20 24","Age 25 29", "Age 30 34", "Age 35 39", "Age 40 44"),
               labels=c("2", "3-5", "6-8", "9-11","12-14","15-17","18-19", "20-24", "25-29", "30-34", "35-39","40-44"))+
scale_y_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 0.01))+
xlab("Age outcomes")+
scale_alpha_manual(values=c(1,1,1), )+
ylab(bquote(atop("Average change in BMI %", "per PP change in input assumption (" *mu[EE]*")")))+
guides(colour = guide_legend("BMI outcomes"), alpha = "none")+
ggtitle("Summary plot - Mean Elementary Effect by age",subtitle="Male outcomes")+
theme_bw()+theme(legend.position = "bottom",
               panel.spacing=unit(0, "mm"),
               plot.title = element_text(face = c("bold")),
               plot.subtitle = element_text(),
               strip.text = element_text(size = 7),
               axis.title.y = element_text(size=7),
               axis.text.x = element_text(size=6),
               axis.text.y = element_text(size=8))


p.tmp2<-lsa_bmi_df %>% 
rename("Gender input"="gender.input", "BMI outcome"="bmi.output", "BMI input"="bmi.input", 
     "Age input"="age.groups.input", "Gender outcome"="gender.output", "Age output"="age.groups.output") %>%
filter(focus.title=="PROTEIN TEF" ) %>%
# filter(`Gender input`=='Male') %>%
filter(`Gender outcome`=='Male') %>%
# filter(`BMI outcome`=="With obesity") %>% 
# filter(`BMI input`=="Overweight" ) %>% 
# filter(`Age input`=="Age 6 8") %>%
filter(`Age output`!="Age 45 49") %>%
ggplot()+
# geom_point(aes(x=prop-100, y=`2057`), color=hue_pal()(3)[3], size=0.4)+
geom_smooth(aes(x=prop-100, y=`2057`, color=`BMI outcome`), se=F, linewidth=0.5, span=0.25)+
# geom_line(aes(x=input.value, y=diff, color=scenario))+
# geom_line(aes(x=input.value, y=base.model.value), linetype="dashed")+
# geom_vline(aes(xintercept=0, color="Initial assumption"), linetype="dashed", alpha=0.3)+
facet_wrap(vars(`Age output`), ncol = 4, nrow=3)+
scale_colour_manual(values = c(hue_pal()(3)))+
guides(colour = guide_legend(" "))+
scale_y_continuous(labels = scales::percent)+
# scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
#                  limits = c(-20, 20))+
scale_x_continuous(labels = scales::label_number(suffix = "%", scale =1, accuracy = 1),
                 limits = c(-20, 20),
                 sec.axis = sec_axis(~(.+100)*0.2/100,
                                     name = "\n TEF \n",
                                     labels =scales::label_number(suffix = "")))+
ylab("BMI Prevalence")+
xlab(" \n Percentage of initial assumed Thermic Effect of Food (TEF) for Protein")+
ggtitle("Individual relationships", subtitle = "Male outcomes vs assumed Thermic Effect of Food (TEF) for Protein")+
theme_bw() +theme(legend.position = "bottom",
                  panel.spacing.y =unit(0, "mm"),
                  panel.spacing.x =unit(4, "mm"),
                  plot.title = element_text(face = c("bold")),
                  plot.subtitle = element_text())

layout <- '
##AAAA##
BBBBBBBB
BBBBBBBB
'
wrap_plots(A = p.tmp1, B = p.tmp2, design = layout, tag_level = "keep")+
# plot_annotation(tag_levels = list(c("A", "B")))&
theme(legend.position = "bottom")
```